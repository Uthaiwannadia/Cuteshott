<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Choose Image</title>

  <!-- à¹ƒà¸Šà¹‰à¹„à¸Ÿà¸¥à¹Œ CSS à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¸™à¹‰à¸­à¸‡ -->
  <link rel="stylesheet" href="upload.css" />
</head>
<body>

  <div class="phone">

    <!-- à¸„à¸£à¸­à¸šà¹‚à¸šà¸§à¹Œ + header PNG à¹„à¸§à¹‰à¸”à¹‰à¸§à¸¢à¸à¸±à¸™ -->
    <div class="header-wrapper">
      <!-- à¹‚à¸šà¸§à¹Œ -->
      <img src="Mymelodyypic/bowpink.png" alt="Bow" class="topbar__bow" />
      <!-- à¹à¸–à¸šà¸«à¸±à¸§ PNG -->
      <img src="Mymelodyypic/chooseimage.png" alt="Menu" class="header-img" />
    </div>

    <!-- à¸à¸£à¸­à¸šà¹ƒà¸«à¸à¹ˆà¸à¸¥à¸²à¸‡ -->
    <div class="frame">
      <div class="choose-wrapper">
        <div class="grid">

          <div class="slot" data-id="1">
            <span class="plus">+</span>
            <p>Picture 1</p>
            <img class="preview" id="img1" />
          </div>

          <div class="slot" data-id="2">
            <span class="plus">+</span>
            <p>Picture 2</p>
            <img class="preview" id="img2" />
          </div>

          <div class="slot" data-id="3">
            <span class="plus">+</span>
            <p>Picture 3</p>
            <img class="preview" id="img3" />
          </div>

          <div class="slot" data-id="4">
            <span class="plus">+</span>
            <p>Picture 4</p>
            <img class="preview" id="img4" />
          </div>

        </div>
      </div>

      <!-- à¸›à¸¸à¹ˆà¸¡à¹„à¸›à¸«à¸™à¹‰à¸² final -->
      <div class="takephoto-wrapper" id="printBtn">
        <img
          src="Mymelodyypic/buttongreen.png"
          class="takephoto-icon"
          alt="Print button"
        />
      </div>
    </div>

  </div>

  <!-- input à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ (à¸‹à¹ˆà¸­à¸™à¹„à¸§à¹‰) -->
  <input type="file" accept="image/*" id="filePicker" hidden />

  <!-- à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¹€à¸¥à¸·à¸­à¸à¸ à¸²à¸ž + à¸¢à¹ˆà¸­à¸£à¸¹à¸› + à¹€à¸‹à¸Ÿà¸¥à¸‡ localStorage + à¹„à¸›à¸«à¸™à¹‰à¸² final -->
  <script>
    const filePicker = document.getElementById("filePicker");
    let currentSlot = null;

    // â­ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸¢à¹ˆà¸­à¸£à¸¹à¸›à¸à¹ˆà¸­à¸™à¹€à¸à¹‡à¸šà¸¥à¸‡ localStorage
    function resizeImage(dataUrl, maxSize = 900) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          let w = img.width;
          let h = img.height;

          // à¸¢à¹ˆà¸­à¹ƒà¸«à¹‰à¸”à¹‰à¸²à¸™à¸—à¸µà¹ˆà¸¢à¸²à¸§à¸ªà¸¸à¸” = maxSize
          if (w > h && w > maxSize) {
            h = (maxSize / w) * h;
            w = maxSize;
          } else if (h >= w && h > maxSize) {
            w = (maxSize / h) * w;
            h = maxSize;
          }

          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);

          // à¸šà¸µà¸šà¸­à¸±à¸”à¹€à¸›à¹‡à¸™ JPEG à¸„à¸¸à¸“à¸ à¸²à¸ž 0.85
          const resized = canvas.toDataURL("image/jpeg", 0.85);
          resolve(resized);
        };
        img.src = dataUrl;
      });
    }

    // â­ à¸„à¸¥à¸´à¸à¸—à¸µà¹ˆà¸à¸£à¸­à¸šà¹à¸•à¹ˆà¸¥à¸°à¸Šà¹ˆà¸­à¸‡ â†’ à¹€à¸›à¸´à¸”à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œ
    document.querySelectorAll(".slot").forEach(slot => {
      slot.addEventListener("click", () => {
        currentSlot = slot.dataset.id;      // "1".."4"
        filePicker.value = "";              // à¸à¸±à¸™à¸šà¸±à¹Šà¸ change à¹„à¸¡à¹ˆà¸—à¸³à¸‡à¸²à¸™
        filePicker.click();
      });
    });

    // â­ à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¹„à¸”à¹‰à¹à¸¥à¹‰à¸§
    filePicker.addEventListener("change", () => {
      const file = filePicker.files[0];
      if (!file || !currentSlot) return;

      const reader = new FileReader();
      reader.onload = async e => {
        const originalDataUrl = e.target.result;

        // âœ… à¸¢à¹ˆà¸­à¸£à¸¹à¸›à¸à¹ˆà¸­à¸™
        const resizedDataUrl = await resizeImage(originalDataUrl);

        // à¹à¸ªà¸”à¸‡à¸žà¸£à¸µà¸§à¸´à¸§à¹ƒà¸™à¸Šà¹ˆà¸­à¸‡
        const img = document.getElementById("img" + currentSlot);
        img.src = resizedDataUrl;
        img.style.display = "block";

        // à¹€à¸à¹‡à¸šà¸¥à¸‡ localStorage à¹ƒà¸«à¹‰à¸«à¸™à¹‰à¸² final à¹ƒà¸Šà¹‰
        try {
          localStorage.setItem("pic" + currentSlot, resizedDataUrl);
          console.log("saved resized: pic" + currentSlot);
        } catch (err) {
          console.error("localStorage error:", err);
          alert("à¸£à¸¹à¸›à¹ƒà¸«à¸à¹ˆà¹€à¸à¸´à¸™à¹„à¸› à¸¥à¸­à¸‡à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸—à¸µà¹ˆà¹€à¸¥à¹‡à¸à¸¥à¸‡à¸«à¸™à¹ˆà¸­à¸¢à¸™à¹‰à¸² ðŸ¥º");
        }
      };
      reader.readAsDataURL(file);
    });

    // â­ à¸›à¸¸à¹ˆà¸¡ Print â†’ à¹„à¸›à¸«à¸™à¹‰à¸² finalup.html
    const printBtn = document.getElementById("printBtn");
    printBtn.addEventListener("click", () => {
      window.location.href = "finalup.html";
    });
  </script>

</body>
</html></html>