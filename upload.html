<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Choose Image</title>

  <!-- ใช้ไฟล์ CSS เดิมของน้อง -->
  <link rel="stylesheet" href="upload.css" />
</head>
<body>

  <div class="phone">

    <!-- ครอบโบว์ + header PNG ไว้ด้วยกัน -->
    <div class="header-wrapper">
      <!-- โบว์ -->
      <img src="Mymelodyypic/bowpink.png" alt="Bow" class="topbar__bow" />
      <!-- แถบหัว PNG -->
      <img src="Mymelodyypic/chooseimage.png" alt="Menu" class="header-img" />
    </div>

    <!-- กรอบใหญ่กลาง -->
    <div class="frame">
      <div class="choose-wrapper">
        <div class="grid">

          <div class="slot" data-id="1">
            <span class="plus">+</span>
            <p>Picture 1</p>
            <img class="preview" id="img1" />
          </div>

          <div class="slot" data-id="2">
            <span class="plus">+</span>
            <p>Picture 2</p>
            <img class="preview" id="img2" />
          </div>

          <div class="slot" data-id="3">
            <span class="plus">+</span>
            <p>Picture 3</p>
            <img class="preview" id="img3" />
          </div>

          <div class="slot" data-id="4">
            <span class="plus">+</span>
            <p>Picture 4</p>
            <img class="preview" id="img4" />
          </div>

        </div>
      </div>
<div class="takephoto-wrapper" id="printBtn">
        <img src="Mymelodyypic/buttongreen.png"
             class="takephoto-icon"
             alt="Print button" />
             </div>
      
    </div>

  </div>

  <!-- input สำหรับเลือกไฟล์ (ซ่อนไว้) -->
  <input type="file" accept="image/*" id="filePicker" hidden />

  <!-- สคริปต์เลือกภาพ + เซฟลง localStorage + ไปหน้า final -->
  <script>
  // ล้างรูปเก่า ป้องกันค่าเก่าค้าง
  ["pic1","pic2","pic3","pic4"].forEach(k => localStorage.removeItem(k));

  const filePicker = document.getElementById("filePicker");
  let currentSlot = null;

  // ฟังก์ชันย่อรูปด้วย canvas
  function resizeImage(file, maxSize = 1200) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          let w = img.width;
          let h = img.height;

          // ย่อให้ด้านที่ยาวสุด = maxSize (แต่ไม่ครอปเนื้อหารูป)
          if (w > h) {
            if (w > maxSize) {
              h = Math.round(h * maxSize / w);
              w = maxSize;
            }
          } else {
            if (h > maxSize) {
              w = Math.round(w * maxSize / h);
              h = maxSize;
            }
          }

          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);

          // แปลงเป็น JPEG คุณภาพ 0.8 (เล็กลงมาก)
          const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
          resolve(dataUrl);
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // คลิกที่กรอบแต่ละช่อง → เปิดเลือกไฟล์
  document.querySelectorAll(".slot").forEach(slot => {
    slot.addEventListener("click", () => {
      currentSlot = slot.dataset.id;      // "1".."4"
      filePicker.value = "";              // กันบั๊ก change ไม่ทำงาน
      filePicker.click();
    });
  });

  // เมื่อเลือกไฟล์ได้แล้ว
  filePicker.addEventListener("change", async () => {
    const file = filePicker.files[0];
    if (!file || !currentSlot) return;

    try {
      // ✅ ย่อรูปก่อน
      const dataUrl = await resizeImage(file, 1200);

      // แสดงพรีวิวในช่อง
      const img = document.getElementById("img" + currentSlot);
      img.src = dataUrl;
      img.style.display = "block";

      // เก็บลง localStorage ให้หน้า final ใช้
      try {
        localStorage.setItem("pic" + currentSlot, dataUrl);
        console.log("saved: pic" + currentSlot, dataUrl.length);
      } catch (e) {
        alert("ไฟล์รูปขนาดใหญ่เกินไป ลองใช้รูปที่ไฟล์เล็กลงนะคะ");
      }
    } catch (err) {
      console.error(err);
      alert("โหลดรูปไม่สำเร็จ ลองใหม่อีกครั้งนะคะ");
    }
  });

  // ปุ่ม Print → ไปหน้า finalup.html (จะเหมือนเดิมแต่ถ้าอยากเช็คว่าเลือกครบก็ทำเพิ่มได้)
  const printBtn = document.getElementById("printBtn");
  printBtn.addEventListener("click", () => {
    // ถ้าอยากบังคับให้ครบ 4 รูปก่อน:
    const required = ["1","2","3","4"];
    for (let id of required) {
      if (!localStorage.getItem("pic" + id)) {
        alert(`เลือกรูปให้ครบ 4 รูปนะคะ :) (ยังขาดรูปที่ ${id})`);
        return;
      }
    }
    window.location.href = "finalup.html";
  });
</script>
</body></html>